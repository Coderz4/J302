<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            min-height: 100vh;
            color: #1d1d1f;
            overflow-x: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 20px 40px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            text-align: center;
            font-size: 40px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .search-container {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 16px 20px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            background: #f5f5f7;
            width: 100%;
            max-width: 500px;
        }

        .search-input:focus {
            outline: 2px solid #007AFF;
            background: white;
        }

        .filter-controls {
            display: flex;
            gap: 8px;
        }

        .filter-select {
            padding: 16px 20px;
            border: none;
            border-radius: 10px;
            background: #f5f5f7;
            font-size: 15px;
            cursor: pointer;
        }

        .calendar-trigger {
            padding: 16px 20px;
            border: none;
            border-radius: 10px;
            background: #f5f5f7;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-trigger:hover {
            background: #e8e8ed;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stats {
            font-size: 15px;
            color: #86868b;
        }

        .add-dream-btn, .menu-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .menu-btn {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .add-dream-btn:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }

        .menu-btn:hover {
            background: #e8e8ed;
            transform: translateY(-1px);
        }

        .add-dream-btn:active, .menu-btn:active {
            transform: translateY(0);
        }

        .menu-container {
            position: relative;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-top: 8px;
            min-width: 180px;
            display: none;
            z-index: 200;
        }

        .menu-dropdown.show {
            display: block;
        }

        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: #f5f5f7;
        }

        .content-area {
            display: grid;
            grid-template-columns: 280px 1fr;
            max-width: 1440px;
            margin: 0 auto;
        }

        @media (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }
            
            .header h1 {
                font-size: 32px;
                margin-bottom: 16px;
            }
            
            .search-container {
                flex-direction: column;
                gap: 12px;
            }
            
            .search-input {
                max-width: 100%;
            }
            
            .filter-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .filter-select {
                flex: 1;
                padding: 12px 16px;
            }
            
            .calendar-trigger {
                padding: 12px 16px;
            }
            
            .controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .add-dream-btn, .menu-btn {
                width: 100%;
                padding: 14px 24px;
            }
            
            .results-grid {
                padding: 20px;
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .results-header {
                padding: 20px;
            }
            
            .dream-card {
                padding: 20px;
            }
            
            .modal {
                width: 95%;
                padding: 24px;
                max-height: 90vh;
            }
            
            .modal h2 {
                font-size: 22px;
                margin-bottom: 20px;
            }
            
            .form-group input,
            .form-group textarea {
                padding: 12px;
                font-size: 16px;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .btn {
                width: 100%;
                padding: 14px 24px;
            }
            
            .calendar-picker {
                min-width: 280px;
                max-width: 95%;
            }
            
            .calendar-header {
                padding: 12px 16px;
            }
            
            .calendar-select {
                font-size: 13px;
                padding: 5px 6px;
            }
            
            .calendar-content {
                padding: 16px;
            }
            
            .calendar-day {
                font-size: 13px;
                min-height: 36px;
            }
            
            .performance-indicator {
                bottom: 16px;
                right: 16px;
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 28px;
            }
            
            .search-input {
                font-size: 16px;
                padding: 12px 16px;
            }
            
            .filter-select,
            .calendar-trigger {
                padding: 10px 14px;
                font-size: 14px;
            }
            
            .stats {
                font-size: 14px;
                text-align: center;
            }
            
            .results-grid {
                padding: 16px;
            }
            
            .dream-card {
                padding: 16px;
            }
            
            .dream-title {
                font-size: 16px;
            }
            
            .dream-content {
                font-size: 14px;
            }
            
            .modal {
                padding: 20px;
            }
            
            .modal h2 {
                font-size: 20px;
            }
            
            .calendar-picker {
                min-width: 260px;
            }
            
            .calendar-day {
                font-size: 12px;
                min-height: 32px;
            }
        }

        .sidebar {
            background: white;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            padding: 40px 32px;
            min-height: calc(100vh - 200px);
        }

        .sidebar h3 {
            margin-bottom: 24px;
            font-size: 20px;
            font-weight: 600;
        }

        .category-list {
            list-style: none;
        }

        .category-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-item:hover {
            background: #f5f5f7;
        }

        .category-item.active {
            background: #007AFF;
            color: white;
        }

        .category-count {
            font-size: 13px;
            background: rgba(0, 0, 0, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .category-item.active .category-count {
            background: rgba(255, 255, 255, 0.2);
        }

        .main-content {
            background: white;
            min-height: calc(100vh - 200px);
        }

        .results-header {
            padding: 32px 40px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .results-grid {
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
        }

        .dream-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .dream-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .dream-date {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 12px;
        }

        .dream-title {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 17px;
        }

        .dream-content {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 16px;
            opacity: 0.8;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .dream-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tag {
            background: #f5f5f7;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .dream-relationships {
            font-size: 13px;
            color: #86868b;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding-top: 16px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
        }
        
        body.modal-open {
            overflow: hidden;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .modal h2 {
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 15px;
            background: #fafafa;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: 2px solid #007AFF;
            background: white;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
        }

        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #86868b;
        }

        .performance-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 1001;
        }

        .calendar-picker {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            min-width: 320px;
            max-width: 400px;
            overflow: hidden;
            padding: 0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
        }

        .calendar-nav {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            color: #007AFF;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .calendar-title-group {
            display: flex;
            gap: 8px;
        }

        .calendar-select {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .calendar-content {
            padding: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 11px;
            color: #86868b;
            font-weight: 600;
            padding: 8px 4px;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            position: relative;
            min-height: 40px;
        }

        .calendar-day:hover:not(.other-month):not(.today) {
            background: rgba(0, 122, 255, 0.1);
        }

        .calendar-day.has-dream::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #007AFF;
            border-radius: 50%;
        }

        .calendar-day.selected {
            background: #007AFF;
            color: white;
            font-weight: 600;
        }

        .calendar-day.today {
            font-weight: 600;
            box-shadow: inset 0 0 0 2px #007AFF;
        }

        .calendar-day.other-month {
            color: #c7c7cc;
            opacity: 0.5;
        }

        .calendar-actions {
            display: flex;
            justify-content: space-between;
            padding: 16px 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
        }

        .calendar-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-btn.primary {
            background: #007AFF;
            color: white;
        }

        .calendar-btn.primary:hover {
            background: #0056CC;
        }

        .calendar-btn.secondary {
            background: white;
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .calendar-btn.secondary:hover {
            background: #f5f5f7;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dream Journal</h1>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search your dreams..." id="searchInput">
            <div class="filter-controls">
                <select class="filter-select" id="dateFilter">
                    <option value="">All Time</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                </select>
                <button class="calendar-trigger" id="calendarTrigger" title="Pick a date">ðŸ“…</button>
            </div>
        </div>
        <div class="controls">
            <div class="stats" id="statsDisplay">0 dreams total</div>
            <button class="add-dream-btn" id="addDreamBtn">Add Dream</button>
            <div class="menu-container">
                <button class="menu-btn" id="menuBtn">Menu</button>
                <div class="menu-dropdown" id="menuDropdown">
                    <div class="menu-item" id="manualBackupBtn">Manual Backup</div>
                    <div class="menu-item" id="driveBackupBtn">Setup Google Drive Backup</div>
                    <div class="menu-item" id="importBackupBtn">Import Backup</div>
                </div>
            </div>
        </div>
    </div>

    <div class="content-area">
        <div class="sidebar">
            <h3>Categories</h3>
            <ul class="category-list" id="categoryList">
                <li class="category-item active" data-category="all">
                    <span>All Dreams</span>
                    <span class="category-count" id="allCount">0</span>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="results-header">
                <span id="resultsCount">0 dreams</span>
            </div>
            <div class="results-grid" id="resultsGrid"></div>
        </div>
    </div>

    <div class="performance-indicator" id="perfIndicator">Ready</div>

    <div class="modal-overlay" id="addDreamModal">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 id="modalTitle">Add New Dream</h2>
            <div class="form-group">
                <label for="dreamDate">Date</label>
                <input type="date" id="dreamDate" required>
            </div>
            <div class="form-group">
                <label for="dreamTitle">Title</label>
                <input type="text" id="dreamTitle" placeholder="Give your dream a title..." required>
            </div>
            <div class="form-group">
                <label for="dreamContent">Content</label>
                <textarea id="dreamContent" placeholder="Describe your dream..." required></textarea>
            </div>
            <div class="form-group">
                <label for="dreamTags">Tags (comma-separated)</label>
                <input type="text" id="dreamTags" placeholder="flying, water, family...">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="saveDreamButton">Save Dream</button>
                <button class="btn btn-secondary" id="deleteDreamButton" style="display: none; background: #FF3B30; color: white;">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="driveSetupModal">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>Google Drive Backup Setup</h2>
            <div id="driveSetupContent">
                <p style="margin-bottom: 20px; color: #86868b; line-height: 1.6;">
                    Connect your Google Drive to automatically backup your dreams daily. Your backups will be stored in a folder you choose.
                </p>
                <div id="driveStatus" style="margin-bottom: 20px; padding: 16px; background: #f5f5f7; border-radius: 10px; display: none;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Status</div>
                    <div id="driveStatusText" style="color: #86868b; font-size: 14px;"></div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" id="closeDriveSetupBtn">Cancel</button>
                    <button class="btn btn-primary" id="connectDriveBtn">Connect Google Drive</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="calendarOverlay">
        <div class="calendar-picker modal">
            <div class="calendar-header">
                <button class="calendar-nav" id="prevMonthBtn">â€¹</button>
                <div class="calendar-title-group">
                    <select class="calendar-select" id="calMonthSelect">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <select class="calendar-select" id="calYearSelect"></select>
                </div>
                <button class="calendar-nav" id="nextMonthBtn">â€º</button>
            </div>
            <div class="calendar-content">
                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-day-header">S</div>
                    <div class="calendar-day-header">M</div>
                    <div class="calendar-day-header">T</div>
                    <div class="calendar-day-header">W</div>
                    <div class="calendar-day-header">T</div>
                    <div class="calendar-day-header">F</div>
                    <div class="calendar-day-header">S</div>
                </div>
            </div>
            <div class="calendar-actions">
                <button class="calendar-btn secondary" id="clearCalBtn">Clear</button>
                <button class="calendar-btn primary" id="todayBtn">Today</button>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
(function() {
    'use strict';
    
    const app = {
        dreams: [],
        filter: '',
        category: 'all',
        dateFilter: null,
        calendarDate: new Date(),
        selectedDate: null,
        editingDreamId: null,
        driveAccessToken: null,
        driveFolderId: null,
        driveBackupFileId: null,
        
        init() {
            try {
                this.loadDreams();
                this.loadDriveConfig();
                this.setupListeners();
                this.render();
                this.initGoogleDrive();
            } catch(e) {
                console.error('Init error:', e);
            }
        },
        
        getLocalDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        },
        
        loadDreams() {
            try {
                const stored = localStorage.getItem('dreams');
                if (stored) {
                    this.dreams = JSON.parse(stored);
                } else {
                    this.dreams = [
                        {
                            id: 1,
                            date: '2025-09-27',
                            title: "Flying Over Mountains",
                            content: "I soared through clouds above snow-capped peaks. The weightlessness was incredible, cool mountain air rushing past. Below, a hidden valley with a crystal-clear lake reflected the morning sun.",
                            tags: ["flying", "mountains", "nature"],
                            category: "Adventure"
                        },
                        {
                            id: 2,
                            date: '2025-09-26',
                            title: "Underwater City",
                            content: "An ancient underwater civilization with glass domes and bioluminescent gardens. Inhabitants communicated through color changes in their skin.",
                            tags: ["underwater", "city", "ancient"],
                            category: "Fantasy"
                        },
                        {
                            id: 3,
                            date: '2025-09-25',
                            title: "Childhood Home",
                            content: "Back in my childhood bedroom, but everything was different. The walls were another color, doors led to rooms that never existed.",
                            tags: ["childhood", "home", "nostalgia"],
                            category: "Memory"
                        }
                    ];
                    this.saveDreams();
                }
            } catch(e) {
                console.error('Load error:', e);
                this.dreams = [];
            }
        },
        
        loadDriveConfig() {
            try {
                const config = localStorage.getItem('driveConfig');
                if (config) {
                    const parsed = JSON.parse(config);
                    this.driveFolderId = parsed.folderId;
                    this.driveBackupFileId = parsed.backupFileId;
                }
            } catch(e) {
                console.error('Drive config load error:', e);
            }
        },
        
        saveDriveConfig() {
            try {
                localStorage.setItem('driveConfig', JSON.stringify({
                    folderId: this.driveFolderId,
                    backupFileId: this.driveBackupFileId
                }));
            } catch(e) {
                console.error('Drive config save error:', e);
            }
        },
        
        saveDreams() {
            try {
                localStorage.setItem('dreams', JSON.stringify(this.dreams));
                this.autoBackup();
                this.scheduleDriveBackup();
            } catch(e) {
                console.error('Save error:', e);
            }
        },
        
        scheduleDriveBackup() {
            if (!this.driveFolderId) return;
            
            const lastDriveBackup = localStorage.getItem('lastDriveBackup');
            const today = new Date().toDateString();
            
            if (lastDriveBackup) {
                const lastBackupDate = new Date(lastDriveBackup).toDateString();
                if (lastBackupDate === today) {
                    return;
                }
            }
            
            if (this.driveAccessToken) {
                this.backupToDrive().then(() => {
                    localStorage.setItem('lastDriveBackup', new Date().toISOString());
                });
            }
        },
        
        autoBackup() {
            try {
                const lastBackup = localStorage.getItem('lastBackup');
                const today = new Date().toDateString();
                
                if (lastBackup) {
                    const lastBackupDate = new Date(lastBackup).toDateString();
                    if (lastBackupDate === today) {
                        return;
                    }
                }
                
                const now = new Date();
                const dateStr = this.getLocalDateString(now);
                
                let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dream Journal Backup</title>
    <style>body{font-family:sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.6}.dream{margin-bottom:40px;padding:20px;background:#f9f9f9;border-radius:8px}</style>
</head>
<body>
    <h1>Dream Journal Backup - ${dateStr}</h1>
    <p>Total Dreams: ${this.dreams.length}</p>
`;

                this.dreams.forEach(dream => {
                    html += `<div class="dream"><h2>${dream.title}</h2><p>${new Date(dream.date).toLocaleDateString()}</p><p>${dream.content}</p><p>Tags: ${dream.tags.join(', ')}</p></div>`;
                });

                html += `<script type="application/json" id="dream-data">${JSON.stringify(this.dreams)}<\/script></body></html>`;

                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Dreams-Backup-${dateStr}.html`;
                a.click();
                URL.revokeObjectURL(url);
                
                localStorage.setItem('lastBackup', now.toISOString());
            } catch(e) {
                console.error('Auto-backup error:', e);
            }
        },
        
        setupListeners() {
            const self = this;
            
            document.getElementById('searchInput').addEventListener('input', function(e) {
                self.filter = e.target.value;
                self.render();
            });
            
            document.getElementById('dateFilter').addEventListener('change', function(e) {
                self.applyDateFilter(e.target.value);
            });
            
            document.getElementById('calendarTrigger').addEventListener('click', function() {
                self.showCalendar();
            });
            
            document.getElementById('addDreamBtn').addEventListener('click', function() {
                self.showModal();
            });
            
            document.getElementById('menuBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                self.toggleMenu();
            });
            
            document.getElementById('manualBackupBtn').addEventListener('click', function() {
                self.manualBackup();
            });
            
            document.getElementById('importBackupBtn').addEventListener('click', function() {
                self.importBackup();
            });
            
            document.getElementById('driveBackupBtn').addEventListener('click', function() {
                self.showDriveSetup();
            });
            
            document.getElementById('connectDriveBtn').addEventListener('click', function() {
                self.connectGoogleDrive();
            });
            
            document.getElementById('closeDriveSetupBtn').addEventListener('click', function() {
                self.hideDriveSetup();
            });
            
            document.getElementById('driveSetupModal').addEventListener('click', function(e) {
                if (e.target === this) self.hideDriveSetup();
            });
            
            document.addEventListener('click', function() {
                self.hideMenu();
            });
            
            document.getElementById('cancelBtn').addEventListener('click', function() {
                self.hideModal();
            });
            
            document.getElementById('saveDreamButton').addEventListener('click', function() {
                self.saveDream();
            });
            
            document.getElementById('deleteDreamButton').addEventListener('click', function() {
                self.deleteCurrentDream();
            });
            
            document.getElementById('addDreamModal').addEventListener('click', function(e) {
                if (e.target === this) self.hideModal();
            });
            
            document.getElementById('calendarOverlay').addEventListener('click', function(e) {
                if (e.target === this) self.hideCalendar();
            });
            
            document.getElementById('prevMonthBtn').addEventListener('click', function() {
                self.prevMonth();
            });
            
            document.getElementById('nextMonthBtn').addEventListener('click', function() {
                self.nextMonth();
            });
            
            document.getElementById('calMonthSelect').addEventListener('change', function() {
                self.updateCalendar();
            });
            
            document.getElementById('calYearSelect').addEventListener('change', function() {
                self.updateCalendar();
            });
            
            document.getElementById('clearCalBtn').addEventListener('click', function() {
                self.clearCalendar();
            });
            
            document.getElementById('todayBtn').addEventListener('click', function() {
                self.goToToday();
            });
            
            document.querySelectorAll('.category-item').forEach(function(el) {
                el.addEventListener('click', function() {
                    self.selectCategory(this.dataset.category);
                });
            });
        },
        
        toggleMenu() {
            document.getElementById('menuDropdown').classList.toggle('show');
        },
        
        hideMenu() {
            document.getElementById('menuDropdown').classList.remove('show');
        },
        
        manualBackup() {
            this.hideMenu();
            const now = new Date();
            const dateStr = this.getLocalDateString(now);
            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Dream Journal Backup</title><style>body{font-family:sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.6}.dream{margin-bottom:40px;padding:20px;background:#f9f9f9;border-radius:8px}</style></head><body><h1>Dream Journal Backup - ${dateStr}</h1><p>Total: ${this.dreams.length}</p>`;
            this.dreams.forEach(d => {
                html += `<div class="dream"><h2>${d.title}</h2><p>${new Date(d.date).toLocaleDateString()}</p><p>${d.content}</p><p>Tags: ${d.tags.join(', ')}</p></div>`;
            });
            html += `<script type="application/json" id="dream-data">${JSON.stringify(this.dreams)}<\/script></body></html>`;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Dreams-Backup-${dateStr}.html`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Backup downloaded');
        },
        
        importBackup() {
            this.hideMenu();
            alert('Import feature coming soon');
        },
        
        initGoogleDrive() {
            window.handleGoogleAuth = (response) => {
                if (response.access_token) {
                    this.driveAccessToken = response.access_token;
                    this.setupDriveFolder();
                }
            };
        },
        
        showDriveSetup() {
            this.hideMenu();
            document.getElementById('driveSetupModal').classList.add('show');
            document.body.classList.add('modal-open');
            
            if (this.driveFolderId) {
                document.getElementById('driveStatus').style.display = 'block';
                document.getElementById('driveStatusText').textContent = 'Google Drive backup is enabled. Daily backups are active.';
                document.getElementById('connectDriveBtn').textContent = 'Reconnect Drive';
            } else {
                document.getElementById('driveStatus').style.display = 'none';
                document.getElementById('connectDriveBtn').textContent = 'Connect Google Drive';
            }
        },
        
        hideDriveSetup() {
            document.getElementById('driveSetupModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        },
        
        connectGoogleDrive() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: '295707121127-qb12m077e8qugk8piql50iu49l4qdumg.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: window.handleGoogleAuth,
            });
            client.requestAccessToken();
        },
        
        async setupDriveFolder() {
            try {
                document.getElementById('driveStatusText').textContent = 'Setting up backup folder...';
                document.getElementById('driveStatus').style.display = 'block';
                
                const folderMetadata = {
                    name: 'Dream Journal Backups',
                    mimeType: 'application/vnd.google-apps.folder'
                };
                
                const folderResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.driveAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(folderMetadata)
                });
                
                const folder = await folderResponse.json();
                this.driveFolderId = folder.id;
                this.saveDriveConfig();
                
                document.getElementById('driveStatusText').textContent = 'Google Drive backup enabled! Your dreams will backup daily.';
                
                await this.backupToDrive();
                
                setTimeout(() => {
                    this.hideDriveSetup();
                }, 2000);
                
            } catch(e) {
                console.error('Drive setup error:', e);
                document.getElementById('driveStatusText').textContent = 'Error setting up Drive. Please try again.';
            }
        },
        
        async backupToDrive() {
            if (!this.driveAccessToken || !this.driveFolderId) {
                return;
            }
            
            try {
                const now = new Date();
                const dateStr = this.getLocalDateString(now);
                const fileName = `Dream-Journal-Backup-${dateStr}.json`;
                
                const fileContent = JSON.stringify({
                    exportDate: now.toISOString(),
                    totalDreams: this.dreams.length,
                    dreams: this.dreams
                }, null, 2);
                
                const metadata = {
                    name: fileName,
                    mimeType: 'application/json',
                    parents: [this.driveFolderId]
                };
                
                if (this.driveBackupFileId) {
                    const updateResponse = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${this.driveBackupFileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${this.driveAccessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: fileContent
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error('Failed to update backup');
                    }
                } else {
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([fileContent], { type: 'application/json' }));
                    
                    const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.driveAccessToken}`
                        },
                        body: form
                    });
                    
                    const file = await uploadResponse.json();
                    this.driveBackupFileId = file.id;
                    this.saveDriveConfig();
                }
                
                console.log('Backed up to Google Drive successfully');
            } catch(e) {
                console.error('Drive backup error:', e);
            }
        },
        
        showModal() {
            this.editingDreamId = null;
            document.getElementById('addDreamModal').classList.add('show');
            document.body.classList.add('modal-open');
            document.getElementById('modalTitle').textContent = 'Add New Dream';
            document.getElementById('saveDreamButton').textContent = 'Save Dream';
            document.getElementById('deleteDreamButton').style.display = 'none';
            document.getElementById('dreamDate').value = this.getLocalDateString(new Date());
            document.getElementById('dreamTitle').value = '';
            document.getElementById('dreamContent').value = '';
            document.getElementById('dreamTags').value = '';
        },
        
        showEditModal(dreamId) {
            const dream = this.dreams.find(d => d.id === dreamId);
            if (!dream) return;
            this.editingDreamId = dreamId;
            document.getElementById('addDreamModal').classList.add('show');
            document.body.classList.add('modal-open');
            document.getElementById('modalTitle').textContent = 'Edit Dream';
            document.getElementById('saveDreamButton').textContent = 'Update Dream';
            document.getElementById('deleteDreamButton').style.display = 'block';
            document.getElementById('dreamDate').value = dream.date;
            document.getElementById('dreamTitle').value = dream.title;
            document.getElementById('dreamContent').value = dream.content;
            document.getElementById('dreamTags').value = dream.tags.join(', ');
        },
        
        hideModal() {
            document.getElementById('addDreamModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            this.editingDreamId = null;
        },
        
        saveDream() {
            const date = document.getElementById('dreamDate').value;
            const title = document.getElementById('dreamTitle').value.trim();
            const content = document.getElementById('dreamContent').value.trim();
            const tags = document.getElementById('dreamTags').value.split(',').map(t => t.trim()).filter(t => t);
            if (!date || !title || !content) {
                alert('Please fill in all required fields');
                return;
            }
            if (this.editingDreamId) {
                const idx = this.dreams.findIndex(d => d.id === this.editingDreamId);
                if (idx !== -1) {
                    this.dreams[idx] = {...this.dreams[idx], date, title, content, tags, category: this.guessCategory(title, content, tags)};
                }
            } else {
                this.dreams.unshift({id: Date.now(), date, title, content, tags, category: this.guessCategory(title, content, tags)});
            }
            this.saveDreams();
            this.hideModal();
            this.render();
        },
        
        deleteDream(dreamId) {
            if (!confirm('Delete this dream?')) return;
            this.dreams = this.dreams.filter(d => d.id !== dreamId);
            this.saveDreams();
            this.render();
        },
        
        deleteCurrentDream() {
            if (this.editingDreamId) {
                this.deleteDream(this.editingDreamId);
                this.hideModal();
            }
        },
        
        guessCategory(title, content, tags) {
            const text = `${title} ${content} ${tags.join(' ')}`.toLowerCase();
            if (text.includes('fly')) return 'Adventure';
            if (text.includes('water') || text.includes('ocean')) return 'Fantasy';
            if (text.includes('home') || text.includes('childhood')) return 'Memory';
            return 'General';
        },
        
        selectCategory(cat) {
            this.category = cat;
            document.querySelectorAll('.category-item').forEach(el => {
                el.classList.toggle('active', el.dataset.category === cat);
            });
            this.render();
        },
        
        applyDateFilter(filter) {
            const now = new Date();
            switch (filter) {
                case 'week': this.dateFilter = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case 'month': this.dateFilter = new Date(now.getFullYear(), now.getMonth(), 1); break;
                case 'year': this.dateFilter = new Date(now.getFullYear(), 0, 1); break;
                default: this.dateFilter = null;
            }
            this.selectedDate = null;
            this.render();
        },
        
        showCalendar() {
            document.getElementById('calendarOverlay').classList.add('show');
            document.body.classList.add('modal-open');
            this.initCalendarYear();
            this.updateCalendar();
        },
        
        hideCalendar() {
            document.getElementById('calendarOverlay').classList.remove('show');
            document.body.classList.remove('modal-open');
        },
        
        initCalendarYear() {
            const yearSelect = document.getElementById('calYearSelect');
            yearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === this.calendarDate.getFullYear()) option.selected = true;
                yearSelect.appendChild(option);
            }
        },
        
        updateCalendar() {
            const monthSelect = document.getElementById('calMonthSelect');
            const yearSelect = document.getElementById('calYearSelect');
            this.calendarDate = new Date(parseInt(yearSelect.value), parseInt(monthSelect.value), 1);
            this.renderCalendar();
        },
        
        renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const year = this.calendarDate.getFullYear();
            const month = this.calendarDate.getMonth();
            const dayHeaders = grid.querySelectorAll('.calendar-day-header');
            grid.innerHTML = '';
            dayHeaders.forEach(h => grid.appendChild(h));
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            const today = new Date();
            const todayString = this.getLocalDateString(today);
            const dreamDates = new Set(this.dreams.map(d => d.date));
            const self = this;
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = currentDate.getDate();
                const dateStr = this.getLocalDateString(currentDate);
                if (currentDate.getMonth() !== month) dayEl.classList.add('other-month');
                if (dateStr === todayString) dayEl.classList.add('today');
                if (dreamDates.has(dateStr)) dayEl.classList.add('has-dream');
                if (this.selectedDate && dateStr === this.selectedDate) dayEl.classList.add('selected');
                dayEl.addEventListener('click', function() { self.selectDate(dateStr); });
                grid.appendChild(dayEl);
            }
            document.getElementById('calMonthSelect').value = month;
            document.getElementById('calYearSelect').value = year;
        },
        
        selectDate(dateStr) {
            this.selectedDate = dateStr;
            this.dateFilter = null;
            document.getElementById('dateFilter').value = '';
            this.hideCalendar();
            this.render();
        },
        
        prevMonth() {
            this.calendarDate = new Date(this.calendarDate.getFullYear(), this.calendarDate.getMonth() - 1, 1);
            this.renderCalendar();
        },
        
        nextMonth() {
            this.calendarDate = new Date(this.calendarDate.getFullYear(), this.calendarDate.getMonth() + 1, 1);
            this.renderCalendar();
        },
        
        clearCalendar() {
            this.selectedDate = null;
            this.dateFilter = null;
            document.getElementById('dateFilter').value = '';
            this.hideCalendar();
            this.render();
        },
        
        goToToday() {
            const today = new Date();
            this.calendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
            this.renderCalendar();
            const todayStr = this.getLocalDateString(today);
            if (this.dreams.some(d => d.date === todayStr)) this.selectDate(todayStr);
        },
        
        getFiltered() {
            const start = performance.now();
            let filtered = this.dreams;
            if (this.selectedDate) {
                filtered = filtered.filter(d => d.date === this.selectedDate);
            } else {
                if (this.category !== 'all') filtered = filtered.filter(d => d.category === this.category);
                if (this.filter) {
                    const q = this.filter.toLowerCase();
                    filtered = filtered.filter(d => d.title.toLowerCase().includes(q) || d.content.toLowerCase().includes(q) || d.tags.some(t => t.toLowerCase().includes(q)));
                }
                if (this.dateFilter) filtered = filtered.filter(d => new Date(d.date) >= this.dateFilter);
            }
            const time = Math.round(performance.now() - start);
            document.getElementById('perfIndicator').textContent = `${time}ms`;
            return filtered;
        },
        
        render() {
            const filtered = this.getFiltered();
            const grid = document.getElementById('resultsGrid');
            const self = this;
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="no-results"><h3>No dreams found</h3></div>';
            } else {
                grid.innerHTML = filtered.map(d => `<div class="dream-card" data-dream-id="${d.id}"><div class="dream-date">${new Date(d.date).toLocaleDateString()}</div><div class="dream-title">${d.title}</div><div class="dream-content">${d.content}</div><div class="dream-tags">${d.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div><div class="dream-relationships">Category: ${d.category}</div></div>`).join('');
                document.querySelectorAll('.dream-card').forEach(card => {
                    card.addEventListener('click', function() {
                        self.showEditModal(parseInt(this.dataset.dreamId));
                    });
                });
            }
            let countText = `${filtered.length} dream${filtered.length !== 1 ? 's' : ''}`;
            if (this.selectedDate) countText += ` on ${new Date(this.selectedDate).toLocaleDateString()}`;
            document.getElementById('resultsCount').textContent = countText;
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const recent = this.dreams.filter(d => new Date(d.date) >= weekAgo).length;
            document.getElementById('statsDisplay').textContent = `${this.dreams.length} dreams total â€¢ ${recent} this week`;
            this.renderCategories();
        },
        
        renderCategories() {
            const cats = {};
            this.dreams.forEach(d => { cats[d.category] = (cats[d.category] || 0) + 1; });
            const list = document.getElementById('categoryList');
            const existing = list.querySelectorAll('[data-category]:not([data-category="all"])');
            existing.forEach(el => el.remove());
            document.getElementById('allCount').textContent = this.dreams.length;
            const self = this;
            Object.entries(cats).sort().forEach(([cat, count]) => {
                const li = document.createElement('li');
                li.className = 'category-item';
                if (cat === this.category) li.classList.add('active');
                li.dataset.category = cat;
                li.innerHTML = `<span>${cat}</span><span class="category-count">${count}</span>`;
                li.addEventListener('click', function() { self.selectCategory(cat); });
                list.appendChild(li);
            });
        }
    };
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { app.init(); });
    } else {
        app.init();
    }
})();
    </script>
</body>
</html>
