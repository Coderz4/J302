<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            color: #1d1d1f;
        }

        .header {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            padding: 20px 40px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            text-align: center;
            font-size: 40px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .search-container {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .search-input {
            padding: 11px 16px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            background: rgba(142, 142, 147, 0.12);
            width: 100%;
            max-width: 500px;
            color: #1d1d1f;
        }

        .search-input:focus {
            outline: none;
            background: rgba(142, 142, 147, 0.18);
            box-shadow: 0 0 0 4px rgba(0, 125, 250, 0.1);
        }

        .search-input::placeholder {
            color: rgba(60, 60, 67, 0.6);
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        .search-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background 0.2s ease;
        }

        .suggestion-item:hover {
            background: #f5f5f7;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-icon {
            margin-right: 8px;
            opacity: 0.6;
        }

        .advanced-filters {
            display: none;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            border-radius: 12px;
            margin-top: 16px;
            width: 100%;
            max-width: 800px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .advanced-filters.show {
            display: block;
        }

        .filter-group {
            margin-bottom: 16px;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-chip {
            padding: 6px 12px;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            color: #1d1d1f;
            letter-spacing: -0.08px;
        }

        .filter-chip:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(0, 125, 250, 0.3);
            transform: translateY(-1px);
        }

        .filter-chip.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        .filter-controls {
            display: flex;
            gap: 8px;
        }

        .filter-select {
            padding: 11px 16px;
            border: none;
            border-radius: 10px;
            background: rgba(142, 142, 147, 0.12);
            font-size: 15px;
            cursor: pointer;
            color: #1d1d1f;
        }

        .calendar-trigger,
        .advanced-trigger {
            padding: 11px 16px;
            border: none;
            border-radius: 10px;
            background: rgba(142, 142, 147, 0.12);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #1d1d1f;
            font-weight: 400;
            letter-spacing: -0.08px;
        }

        .calendar-trigger:hover,
        .advanced-trigger:hover {
            background: rgba(142, 142, 147, 0.18);
        }

        .advanced-trigger.active {
            background: #007AFF;
            color: white;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stats {
            font-size: 15px;
            color: #86868b;
        }

        .add-dream-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 11px 22px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s ease;
            letter-spacing: -0.08px;
        }

        .add-dream-btn:hover {
            background: #0077ED;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 125, 250, 0.25);
        }

        .add-dream-btn:active {
            transform: translateY(0);
        }

        .content-area {
            display: grid;
            grid-template-columns: 280px 1fr;
            max-width: 1440px;
            margin: 0 auto;
        }

        @media (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            border-right: 1px solid rgba(0, 0, 0, 0.06);
            padding: 40px 32px;
            min-height: calc(100vh - 200px);
        }

        .sidebar h3 {
            margin-bottom: 24px;
            font-size: 20px;
            font-weight: 600;
        }

        .category-list {
            list-style: none;
        }

        .category-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-item:hover {
            background: rgba(142, 142, 147, 0.12);
        }

        .category-item.active {
            background: #007AFF;
            color: white;
        }

        .category-count {
            font-size: 13px;
            background: rgba(0, 0, 0, 0.06);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .category-item.active .category-count {
            background: rgba(255, 255, 255, 0.25);
        }

        .saved-searches {
            margin-top: 32px;
        }

        .saved-search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: #f5f5f7;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .saved-search-item:hover {
            background: #e8e8ed;
        }

        .saved-search-delete {
            background: none;
            border: none;
            color: #FF3B30;
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            min-height: calc(100vh - 200px);
        }

        .results-header {
            padding: 32px 40px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .search-stats {
            font-size: 13px;
            color: #007AFF;
            padding: 8px 16px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .results-grid {
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
        }

        .dream-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            border: 0.5px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .dream-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 0, 0, 0.12);
        }

        .dream-date {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 12px;
        }

        .dream-title {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 17px;
        }

        .dream-content {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 16px;
            opacity: 0.8;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .dream-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tag {
            background: rgba(142, 142, 147, 0.12);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 400;
            letter-spacing: -0.08px;
        }

        .dream-relationships {
            font-size: 13px;
            color: #86868b;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding-top: 16px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .modal h2 {
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 15px;
            background: #fafafa;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: 2px solid #007AFF;
            background: white;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
        }

        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #86868b;
        }

        .performance-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 1001;
        }

        .calendar-picker {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            min-width: 320px;
            max-width: 400px;
            overflow: hidden;
            padding: 0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
        }

        .calendar-nav {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            color: #007AFF;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .calendar-title-group {
            display: flex;
            gap: 8px;
        }

        .calendar-select {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .calendar-content {
            padding: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 11px;
            color: #86868b;
            font-weight: 600;
            padding: 8px 4px;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            position: relative;
            min-height: 40px;
        }

        .calendar-day:hover:not(.other-month):not(.today) {
            background: rgba(0, 122, 255, 0.1);
        }

        .calendar-day.has-dream::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #007AFF;
            border-radius: 50%;
        }

        .calendar-day.selected {
            background: #007AFF;
            color: white;
            font-weight: 600;
        }

        .calendar-day.today {
            font-weight: 600;
            box-shadow: inset 0 0 0 2px #007AFF;
        }

        .calendar-day.other-month {
            color: #c7c7cc;
            opacity: 0.5;
        }

        .calendar-actions {
            display: flex;
            justify-content: space-between;
            padding: 16px 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
        }

        .calendar-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-btn.primary {
            background: #007AFF;
            color: white;
        }

        .calendar-btn.primary:hover {
            background: #0056CC;
        }

        .calendar-btn.secondary {
            background: white;
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .calendar-btn.secondary:hover {
            background: #f5f5f7;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dream Journal</h1>
        <div class="search-container">
            <div style="position: relative; width: 100%; max-width: 500px;">
                <input type="text" class="search-input" placeholder="Search your dreams..." id="searchInput" autocomplete="off">
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            <div class="filter-controls">
                <select class="filter-select" id="dateFilter">
                    <option value="">All Time</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                </select>
                <button class="calendar-trigger" id="calendarTrigger" title="Pick a date">Calendar</button>
                <button class="advanced-trigger" id="advancedTrigger" title="Advanced filters">Filters</button>
            </div>
        </div>
        <div class="advanced-filters" id="advancedFilters">
            <div class="filter-group">
                <label>Themes</label>
                <div class="filter-chips" id="themeFilters">
                    <div class="filter-chip" data-theme="adventure" onclick="window.app.toggleTheme('adventure')">Adventure</div>
                    <div class="filter-chip" data-theme="fantasy" onclick="window.app.toggleTheme('fantasy')">Fantasy</div>
                    <div class="filter-chip" data-theme="memory" onclick="window.app.toggleTheme('memory')">Memory</div>
                    <div class="filter-chip" data-theme="nature" onclick="window.app.toggleTheme('nature')">Nature</div>
                    <div class="filter-chip" data-theme="urban" onclick="window.app.toggleTheme('urban')">Urban</div>
                </div>
            </div>
            <div class="filter-group">
                <label>Mood</label>
                <div class="filter-chips" id="moodFilters">
                    <div class="filter-chip" data-mood="peaceful" onclick="window.app.toggleMood('peaceful')">Peaceful</div>
                    <div class="filter-chip" data-mood="exciting" onclick="window.app.toggleMood('exciting')">Exciting</div>
                    <div class="filter-chip" data-mood="mysterious" onclick="window.app.toggleMood('mysterious')">Mysterious</div>
                    <div class="filter-chip" data-mood="nostalgic" onclick="window.app.toggleMood('nostalgic')">Nostalgic</div>
                </div>
            </div>
        </div>
        <div class="controls">
            <div class="stats" id="statsDisplay">0 dreams total</div>
            <button class="add-dream-btn" id="addDreamBtn" onclick="window.app.showModal()">Add Dream</button>
        </div>
    </div>

    <div class="content-area">
        <div class="sidebar">
            <h3>Categories</h3>
            <ul class="category-list" id="categoryList">
                <li class="category-item active" data-category="all" onclick="window.app.selectCategory('all')">
                    <span>All Dreams</span>
                    <span class="category-count" id="allCount">0</span>
                </li>
            </ul>
            
            <div class="saved-searches">
                <h3>Saved Searches</h3>
                <div id="savedSearchesList"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="results-header">
                <div class="search-stats" id="searchStats" style="display: none;"></div>
                <span id="resultsCount">0 dreams</span>
            </div>
            <div class="results-grid" id="resultsGrid"></div>
        </div>
    </div>

    <div class="performance-indicator" id="perfIndicator">Ready</div>

    <div class="modal-overlay" id="addDreamModal">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 id="modalTitle">Add New Dream</h2>
            <div class="form-group">
                <label for="dreamDate">Date</label>
                <input type="date" id="dreamDate" required>
            </div>
            <div class="form-group">
                <label for="dreamTitle">Title</label>
                <input type="text" id="dreamTitle" placeholder="Give your dream a title..." required>
            </div>
            <div class="form-group">
                <label for="dreamContent">Content</label>
                <textarea id="dreamContent" placeholder="Describe your dream..." required></textarea>
            </div>
            <div class="form-group">
                <label for="dreamTags">Tags (comma-separated)</label>
                <input type="text" id="dreamTags" placeholder="flying, water, family...">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="window.app.hideModal()">Cancel</button>
                <button class="btn btn-primary" id="saveDreamButton" onclick="window.app.saveDream()">Save Dream</button>
                <button class="btn btn-secondary" id="deleteDreamButton" onclick="window.app.deleteCurrentDream()" style="display: none; background: #FF3B30; color: white;">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="calendarOverlay" onclick="if(event.target === this) window.app.hideCalendar()">
        <div class="calendar-picker modal">
            <div class="calendar-header">
                <button class="calendar-nav" onclick="window.app.prevMonth()">‹</button>
                <div class="calendar-title-group">
                    <select class="calendar-select" id="calMonthSelect" onchange="window.app.updateCalendar()">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <select class="calendar-select" id="calYearSelect" onchange="window.app.updateCalendar()"></select>
                </div>
                <button class="calendar-nav" onclick="window.app.nextMonth()">›</button>
            </div>
            <div class="calendar-content">
                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-day-header">S</div>
                    <div class="calendar-day-header">M</div>
                    <div class="calendar-day-header">T</div>
                    <div class="calendar-day-header">W</div>
                    <div class="calendar-day-header">T</div>
                    <div class="calendar-day-header">F</div>
                    <div class="calendar-day-header">S</div>
                </div>
            </div>
            <div class="calendar-actions">
                <button class="calendar-btn secondary" onclick="window.app.clearCalendar()">Clear</button>
                <button class="calendar-btn primary" onclick="window.app.goToToday()">Today</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script>
        window.app = {
            dreams: [],
            filter: '',
            category: 'all',
            dateFilter: null,
            calendarDate: new Date(),
            selectedDate: null,
            editingDreamId: null,
            savedSearches: [],
            activeThemes: [],
            activeMoods: [],
            searchEngine: null,
            
            init() {
                console.log('App initializing...');
                this.initSearchEngine();
                this.loadDreams();
                this.loadSavedSearches();
                this.setupListeners();
                this.render();
                console.log('App initialized with', this.dreams.length, 'dreams');
            },
            
            initSearchEngine() {
                this.searchEngine = {
                    themes: {
                        flight: ['flying', 'soaring', 'floating', 'hovering', 'gliding', 'airborne', 'weightless', 'sky', 'clouds', 'wings'],
                        water: ['underwater', 'ocean', 'sea', 'swimming', 'diving', 'aquatic', 'marine', 'beach', 'waves', 'lake', 'river'],
                        nature: ['mountains', 'forest', 'trees', 'wildlife', 'outdoors', 'wilderness', 'landscape', 'garden', 'flowers', 'animals'],
                        urban: ['city', 'building', 'street', 'urban', 'metropolis', 'town', 'downtown', 'architecture', 'skyscraper'],
                        ancient: ['ancient', 'old', 'historical', 'ruins', 'past', 'antiquated', 'vintage', 'classic', 'traditional'],
                        home: ['home', 'house', 'childhood', 'family', 'bedroom', 'room', 'apartment', 'domestic'],
                        adventure: ['adventure', 'journey', 'quest', 'explore', 'travel', 'discovery', 'expedition'],
                        fantasy: ['magic', 'fantasy', 'mystical', 'enchanted', 'mythical', 'supernatural', 'wizard', 'dragon']
                    },
                    
                    moods: {
                        peaceful: ['peaceful', 'calm', 'serene', 'tranquil', 'relaxed', 'quiet', 'gentle', 'soothing'],
                        exciting: ['exciting', 'thrilling', 'energetic', 'intense', 'exhilarating', 'vibrant', 'dynamic'],
                        mysterious: ['mysterious', 'enigmatic', 'strange', 'bizarre', 'unknown', 'cryptic', 'puzzling'],
                        nostalgic: ['nostalgic', 'memory', 'remember', 'past', 'childhood', 'reminisce', 'sentimental']
                    },
                    
                    search(query, dreams) {
                        const queryLower = query.toLowerCase();
                        const words = queryLower.split(/\s+/).filter(w => w.length > 2);
                        
                        return dreams.map(dream => {
                            const text = `${dream.title} ${dream.content} ${dream.tags.join(' ')}`.toLowerCase();
                            let score = 0;
                            let matchedThemes = [];
                            let matchedMoods = [];
                            
                            words.forEach(word => {
                                const regex = new RegExp('\\b' + word, 'i');
                                if (regex.test(text)) score += 10;
                            });
                            
                            Object.entries(this.themes).forEach(([theme, synonyms]) => {
                                let themeScore = 0;
                                synonyms.forEach(synonym => {
                                    if (queryLower.includes(synonym)) {
                                        synonyms.forEach(relatedWord => {
                                            if (text.includes(relatedWord)) themeScore += 3;
                                        });
                                    }
                                });
                                if (themeScore > 0) {
                                    score += themeScore;
                                    matchedThemes.push(theme);
                                }
                            });
                            
                            Object.entries(this.moods).forEach(([mood, keywords]) => {
                                keywords.forEach(keyword => {
                                    if (text.includes(keyword)) matchedMoods.push(mood);
                                });
                            });
                            
                            return { 
                                ...dream, 
                                score,
                                matchedThemes: [...new Set(matchedThemes)],
                                matchedMoods: [...new Set(matchedMoods)]
                            };
                        }).filter(d => d.score > 0).sort((a, b) => b.score - a.score);
                    },
                    
                    getSuggestions(query) {
                        if (!query || query.length < 2) return [];
                        const suggestions = [];
                        const queryLower = query.toLowerCase();
                        
                        Object.entries(this.themes).forEach(([theme, synonyms]) => {
                            synonyms.forEach(synonym => {
                                if (synonym.startsWith(queryLower) && !suggestions.includes(synonym)) {
                                    suggestions.push(synonym);
                                }
                            });
                        });
                        
                        return suggestions.slice(0, 5);
                    }
                };
            },
            
            getLocalDateString(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return year + '-' + month + '-' + day;
            },
            
            loadDreams() {
                const stored = localStorage.getItem('dreams');
                if (stored) {
                    this.dreams = JSON.parse(stored);
                } else {
                    this.dreams = [
                        {
                            id: 1,
                            date: '2025-09-27',
                            title: "Flying Over Mountains",
                            content: "I soared through clouds above snow-capped peaks. The weightlessness was incredible, cool mountain air rushing past. Below, a hidden valley with a crystal-clear lake reflected the morning sun.",
                            tags: ["flying", "mountains", "nature"],
                            category: "Adventure"
                        },
                        {
                            id: 2,
                            date: '2025-09-26',
                            title: "Underwater City",
                            content: "An ancient underwater civilization with glass domes and bioluminescent gardens. Inhabitants communicated through color changes in their skin.",
                            tags: ["underwater", "city", "ancient"],
                            category: "Fantasy"
                        },
                        {
                            id: 3,
                            date: '2025-09-25',
                            title: "Childhood Home",
                            content: "Back in my childhood bedroom, but everything was different. The walls were another color, doors led to rooms that never existed.",
                            tags: ["childhood", "home", "nostalgia"],
                            category: "Memory"
                        }
                    ];
                    this.saveDreams();
                }
            },
            
            saveDreams() {
                localStorage.setItem('dreams', JSON.stringify(this.dreams));
            },
            
            loadSavedSearches() {
                const stored = localStorage.getItem('savedSearches');
                if (stored) {
                    this.savedSearches = JSON.parse(stored);
                } else {
                    this.savedSearches = [];
                }
                this.renderSavedSearches();
            },
            
            saveSavedSearches() {
                localStorage.setItem('savedSearches', JSON.stringify(this.savedSearches));
                this.renderSavedSearches();
            },
            
            setupListeners() {
                const searchInput = document.getElementById('searchInput');
                const dateFilter = document.getElementById('dateFilter');
                const calendarTrigger = document.getElementById('calendarTrigger');
                const advancedTrigger = document.getElementById('advancedTrigger');
                const modalOverlay = document.getElementById('addDreamModal');
                
                searchInput.oninput = (e) => {
                    this.filter = e.target.value;
                    this.showSearchSuggestions(e.target.value);
                    this.render();
                };
                
                searchInput.onkeydown = (e) => {
                    if (e.key === 'Enter' && this.filter.trim()) {
                        this.saveSearch(this.filter);
                        this.hideSuggestions();
                    }
                    if (e.key === 'Escape') {
                        this.hideSuggestions();
                    }
                };
                
                searchInput.onfocus = (e) => {
                    if (e.target.value) {
                        this.showSearchSuggestions(e.target.value);
                    }
                };
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-input') && !e.target.closest('.search-suggestions')) {
                        this.hideSuggestions();
                    }
                });
                
                dateFilter.onchange = (e) => {
                    this.applyDateFilter(e.target.value);
                };
                
                calendarTrigger.onclick = () => {
                    this.showCalendar();
                };
                
                advancedTrigger.onclick = () => {
                    this.toggleAdvancedFilters();
                };
                
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) {
                        this.hideModal();
                    }
                };
            },
            
            toggleAdvancedFilters() {
                const filters = document.getElementById('advancedFilters');
                const trigger = document.getElementById('advancedTrigger');
                filters.classList.toggle('show');
                trigger.classList.toggle('active');
            },
            
            toggleTheme(theme) {
                const index = this.activeThemes.indexOf(theme);
                if (index > -1) {
                    this.activeThemes.splice(index, 1);
                } else {
                    this.activeThemes.push(theme);
                }
                
                const chip = document.querySelector(`[data-theme="${theme}"]`);
                chip.classList.toggle('active');
                this.render();
            },
            
            toggleMood(mood) {
                const index = this.activeMoods.indexOf(mood);
                if (index > -1) {
                    this.activeMoods.splice(index, 1);
                } else {
                    this.activeMoods.push(mood);
                }
                
                const chip = document.querySelector(`[data-mood="${mood}"]`);
                chip.classList.toggle('active');
                this.render();
            },
            
            showSearchSuggestions(query) {
                const suggestionsDiv = document.getElementById('searchSuggestions');
                
                if (!query || query.length < 2) {
                    this.hideSuggestions();
                    return;
                }
                
                const suggestions = this.searchEngine.getSuggestions(query);
                
                if (suggestions.length === 0) {
                    this.hideSuggestions();
                    return;
                }
                
                suggestionsDiv.innerHTML = suggestions.map(s => 
                    `<div class="suggestion-item" onclick="window.app.applySuggestion('${s}')">
                        <span class="suggestion-icon">🔍</span>${s}
                    </div>`
                ).join('');
                
                suggestionsDiv.classList.add('show');
            },
            
            hideSuggestions() {
                document.getElementById('searchSuggestions').classList.remove('show');
            },
            
            applySuggestion(suggestion) {
                document.getElementById('searchInput').value = suggestion;
                this.filter = suggestion;
                this.hideSuggestions();
                this.render();
            },
            
            saveSearch(query) {
                if (!query.trim()) return;
                
                const search = {
                    id: Date.now(),
                    query: query.trim(),
                    date: new Date().toISOString()
                };
                
                if (!this.savedSearches.some(s => s.query === search.query)) {
                    this.savedSearches.unshift(search);
                    if (this.savedSearches.length > 10) {
                        this.savedSearches = this.savedSearches.slice(0, 10);
                    }
                    this.saveSavedSearches();
                }
            },
            
            applySavedSearch(query) {
                document.getElementById('searchInput').value = query;
                this.filter = query;
                this.render();
            },
            
            deleteSavedSearch(id) {
                this.savedSearches = this.savedSearches.filter(s => s.id !== id);
                this.saveSavedSearches();
            },
            
            renderSavedSearches() {
                const container = document.getElementById('savedSearchesList');
                if (this.savedSearches.length === 0) {
                    container.innerHTML = '<p style="color: #86868b; font-size: 13px; padding: 12px 0;">No saved searches yet</p>';
                    return;
                }
                
                container.innerHTML = this.savedSearches.map(s => 
                    `<div class="saved-search-item" onclick="window.app.applySavedSearch('${s.query.replace(/'/g, "\\'")}')">
                        <span>🔍 ${s.query}</span>
                        <button class="saved-search-delete" onclick="event.stopPropagation(); window.app.deleteSavedSearch(${s.id})">×</button>
                    </div>`
                ).join('');
            },
            
            showModal() {
                this.editingDreamId = null;
                const modal = document.getElementById('addDreamModal');
                modal.classList.add('show');
                document.getElementById('modalTitle').textContent = 'Add New Dream';
                document.getElementById('saveDreamButton').textContent = 'Save Dream';
                document.getElementById('deleteDreamButton').style.display = 'none';
                document.getElementById('dreamDate').value = this.getLocalDateString(new Date());
                document.getElementById('dreamTitle').value = '';
                document.getElementById('dreamContent').value = '';
                document.getElementById('dreamTags').value = '';
                setTimeout(() => document.getElementById('dreamTitle').focus(), 100);
            },
            
            showEditModal(dreamId) {
                const dream = this.dreams.find(d => d.id === dreamId);
                if (!dream) return;
                
                this.editingDreamId = dreamId;
                const modal = document.getElementById('addDreamModal');
                modal.classList.add('show');
                
                document.getElementById('modalTitle').textContent = 'Edit Dream';
                document.getElementById('saveDreamButton').textContent = 'Update Dream';
                document.getElementById('deleteDreamButton').style.display = 'block';
                document.getElementById('dreamDate').value = dream.date;
                document.getElementById('dreamTitle').value = dream.title;
                document.getElementById('dreamContent').value = dream.content;
                document.getElementById('dreamTags').value = dream.tags.join(', ');
                
                setTimeout(() => document.getElementById('dreamTitle').focus(), 100);
            },
            
            openDream(dreamId) {
                this.showEditModal(dreamId);
            },
            
            hideModal() {
                document.getElementById('addDreamModal').classList.remove('show');
                this.editingDreamId = null;
            },
            
            saveDream() {
                const date = document.getElementById('dreamDate').value;
                const title = document.getElementById('dreamTitle').value.trim();
                const content = document.getElementById('dreamContent').value.trim();
                const tags = document.getElementById('dreamTags').value.split(',').map(t => t.trim()).filter(t => t);
                
                if (!date || !title || !content) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                if (this.editingDreamId) {
                    const dreamIndex = this.dreams.findIndex(d => d.id === this.editingDreamId);
                    if (dreamIndex !== -1) {
                        this.dreams[dreamIndex] = {
                            ...this.dreams[dreamIndex],
                            date,
                            title,
                            content,
                            tags,
                            category: this.guessCategory(title, content, tags)
                        };
                    }
                } else {
                    const dream = {
                        id: Date.now(),
                        date,
                        title,
                        content,
                        tags,
                        category: this.guessCategory(title, content, tags)
                    };
                    this.dreams.unshift(dream);
                }
                
                this.saveDreams();
                this.hideModal();
                this.render();
            },
            
            deleteDream(dreamId) {
                if (!confirm('Are you sure you want to delete this dream? This cannot be undone.')) {
                    return;
                }
                
                this.dreams = this.dreams.filter(d => d.id !== dreamId);
                this.saveDreams();
                this.render();
            },
            
            deleteCurrentDream() {
                if (this.editingDreamId) {
                    this.deleteDream(this.editingDreamId);
                    this.hideModal();
                }
            },
            
            guessCategory(title, content, tags) {
                const text = `${title} ${content} ${tags.join(' ')}`.toLowerCase();
                if (text.includes('fly')) return 'Adventure';
                if (text.includes('water') || text.includes('ocean')) return 'Fantasy';
                if (text.includes('home') || text.includes('childhood')) return 'Memory';
                return 'General';
            },
            
            selectCategory(cat) {
                this.category = cat;
                document.querySelectorAll('.category-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.category === cat);
                });
                this.render();
            },
            
            applyDateFilter(filter) {
                const now = new Date();
                switch (filter) {
                    case 'week':
                        this.dateFilter = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        this.dateFilter = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'year':
                        this.dateFilter = new Date(now.getFullYear(), 0, 1);
                        break;
                    default:
                        this.dateFilter = null;
                }
                this.selectedDate = null;
                this.render();
            },
            
            showCalendar() {
                document.getElementById('calendarOverlay').classList.add('show');
                this.initCalendarYear();
                this.updateCalendar();
            },
            
            hideCalendar() {
                document.getElementById('calendarOverlay').classList.remove('show');
            },
            
            initCalendarYear() {
                const yearSelect = document.getElementById('calYearSelect');
                yearSelect.innerHTML = '';
                const currentYear = new Date().getFullYear();
                
                for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === this.calendarDate.getFullYear()) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                }
            },
            
            updateCalendar() {
                const monthSelect = document.getElementById('calMonthSelect');
                const yearSelect = document.getElementById('calYearSelect');
                this.calendarDate = new Date(parseInt(yearSelect.value), parseInt(monthSelect.value), 1);
                this.renderCalendar();
            },
            
            renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const year = this.calendarDate.getFullYear();
                const month = this.calendarDate.getMonth();
                const dayHeaders = grid.querySelectorAll('.calendar-day-header');
                grid.innerHTML = '';
                dayHeaders.forEach(header => grid.appendChild(header));
                const firstDay = new Date(year, month, 1);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                const today = new Date();
                const todayString = this.getLocalDateString(today);
                const dreamDates = new Set(this.dreams.map(d => d.date));
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = currentDate.getDate();
                    const dateString = this.getLocalDateString(currentDate);
                    if (currentDate.getMonth() !== month) dayElement.classList.add('other-month');
                    if (dateString === todayString) dayElement.classList.add('today');
                    if (dreamDates.has(dateString)) dayElement.classList.add('has-dream');
                    if (this.selectedDate && dateString === this.selectedDate) dayElement.classList.add('selected');
                    dayElement.onclick = () => this.selectDate(dateString);
                    grid.appendChild(dayElement);
                }
                document.getElementById('calMonthSelect').value = month;
                document.getElementById('calYearSelect').value = year;
            },
            
            selectDate(dateString) {
                this.selectedDate = dateString;
                this.dateFilter = null;
                document.getElementById('dateFilter').value = '';
                this.hideCalendar();
                this.render();
            },
            
            prevMonth() {
                this.calendarDate = new Date(this.calendarDate.getFullYear(), this.calendarDate.getMonth() - 1, 1);
                this.renderCalendar();
            },
            
            nextMonth() {
                this.calendarDate = new Date(this.calendarDate.getFullYear(), this.calendarDate.getMonth() + 1, 1);
                this.renderCalendar();
            },
            
            clearCalendar() {
                this.selectedDate = null;
                this.dateFilter = null;
                document.getElementById('dateFilter').value = '';
                this.hideCalendar();
                this.render();
            },
            
            goToToday() {
                const today = new Date();
                this.calendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
                this.renderCalendar();
                const todayString = this.getLocalDateString(today);
                const hasDreams = this.dreams.some(d => d.date === todayString);
                if (hasDreams) this.selectDate(todayString);
            },
            
            getFiltered() {
                const start = performance.now();
                let filtered = this.dreams;
                let usingSemanticSearch = false;
                
                if (this.selectedDate) {
                    filtered = filtered.filter(d => d.date === this.selectedDate);
                } else {
                    if (this.category !== 'all') {
                        filtered = filtered.filter(d => d.category === this.category);
                    }
                    if (this.dateFilter) {
                        filtered = filtered.filter(d => new Date(d.date) >= this.dateFilter);
                    }
                }
                
                if (this.filter) {
                    const searchResults = this.searchEngine.search(this.filter, filtered);
                    filtered = searchResults;
                    usingSemanticSearch = true;
                }
                
                if (this.activeThemes.length > 0) {
                    filtered = filtered.filter(dream => {
                        const text = `${dream.title} ${dream.content} ${dream.tags.join(' ')}`.toLowerCase();
                        return this.activeThemes.some(theme => {
                            const synonyms = this.searchEngine.themes[theme] || [];
                            return synonyms.some(syn => text.includes(syn));
                        });
                    });
                }
                
                if (this.activeMoods.length > 0) {
                    filtered = filtered.filter(dream => {
                        const text = `${dream.title} ${dream.content}`.toLowerCase();
                        return this.activeMoods.some(mood => {
                            const keywords = this.searchEngine.moods[mood] || [];
                            return keywords.some(keyword => text.includes(keyword));
                        });
                    });
                }
                
                const time = Math.round(performance.now() - start);
                document.getElementById('perfIndicator').textContent = `${time}ms`;
                
                if (this.filter && usingSemanticSearch && filtered.length > 0) {
                    const statsEl = document.getElementById('searchStats');
                    statsEl.style.display = 'inline-block';
                    statsEl.textContent = `✨ Found ${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;
                } else {
                    document.getElementById('searchStats').style.display = 'none';
                }
                
                return filtered;
            },
            
            render() {
                const filtered = this.getFiltered();
                const grid = document.getElementById('resultsGrid');
                if (filtered.length === 0) {
                    grid.innerHTML = '<div class="no-results"><h3>No dreams found</h3><p>Try adjusting your search or filters</p></div>';
                } else {
                    const self = this;
                    grid.innerHTML = filtered.map(d => `<div class="dream-card" data-dream-id="${d.id}"><div class="dream-date">${new Date(d.date).toLocaleDateString()}</div><div class="dream-title">${d.title}</div><div class="dream-content">${d.content}</div><div class="dream-tags">${d.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div><div class="dream-relationships">Category: ${d.category}</div></div>`).join('');
                    document.querySelectorAll('.dream-card').forEach(card => {
                        card.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const dreamId = parseInt(this.dataset.dreamId);
                            self.openDream(dreamId);
                        });
                    });
                }
                let countText = `${filtered.length} dream${filtered.length !== 1 ? 's' : ''}`;
                if (this.selectedDate) countText += ` on ${new Date(this.selectedDate).toLocaleDateString()}`;
                document.getElementById('resultsCount').textContent = countText;
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                const recent = this.dreams.filter(d => new Date(d.date) >= weekAgo).length;
                document.getElementById('statsDisplay').textContent = `${this.dreams.length} dreams total • ${recent} this week`;
                this.renderCategories();
            },
            
            renderCategories() {
                const cats = {};
                this.dreams.forEach(d => { cats[d.category] = (cats[d.category] || 0) + 1; });
                const list = document.getElementById('categoryList');
                const existing = list.querySelectorAll('[data-category]:not([data-category="all"])');
                existing.forEach(el => el.remove());
                document.getElementById('allCount').textContent = this.dreams.length;
                Object.entries(cats).sort().forEach(([cat, count]) => {
                    const li = document.createElement('li');
                    li.className = 'category-item';
                    if (cat === this.category) li.classList.add('active');
                    li.dataset.category = cat;
                    li.onclick = () => this.selectCategory(cat);
                    li.innerHTML = `<span>${cat}</span><span class="category-count">${count}</span>`;
                    list.appendChild(li);
                });
            }
        };
        window.app.init();
    </script>
</body>
</html>

